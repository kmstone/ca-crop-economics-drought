<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>California Crop Economics</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap-theme.min.css">
	<!-- JQuery -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Latest compiled and minified bootstrap JavaScript -->
    <script src="bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
    <!-- Slider bar css -->
    <link rel="stylesheet" href="bootstrap-slider-master/css/bootstrap-slider.css">
    <!-- Slider bar js -->
    <script src="bootstrap-slider-master/js/bootstrap-slider.js"></script>
    <!-- d3 -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <!-- spin.js -->
    <script src="spin_js/spin.js"></script>
    <!-- Leaflet -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />

    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div class="container">

    <!-- Static navbar -->
    <!--<nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Project name</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Contact</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Action</a></li>
                            <li><a href="#">Another action</a></li>
                            <li><a href="#">Something else here</a></li>
                            <li role="separator" class="divider"></li>
                            <li class="dropdown-header">Nav header</li>
                            <li><a href="#">Separated link</a></li>
                            <li><a href="#">One more separated link</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li class="active"><a href="./">Default <span class="sr-only">(current)</span></a></li>
                    <li><a href="../navbar-static-top/">Static top</a></li>
                    <li><a href="../navbar-fixed-top/">Fixed top</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        <!--</div><!--/.container-fluid -->
    <!--</nav>-->

    <!-- Main component for a primary marketing message or call to action -->
    <div class="jumbotron">
        <h2>California Crop Economics</h2>

        <!-- Control bar -->
        <div class="row control">

            <!-- Analysis Unit Control-->
            <div class="col-md-3">
                <label class="control-label">Analysis Unit</label>
                <form class="form-horizontal">
                    <fieldset>
                        <div class="form-group">
                            <div class="col-xs-9">
                                <div class="radio">
                                        <input id="rd1" name="a_unit_radio" value="HR" type="radio" checked="checked">
                                        <label for="rd1">Hydrologic Region</label>
                                </div>
                                <div class="radio">
                                        <input id="rd2" name="a_unit_radio" value="PA" type="radio">
                                        <label for="rd2">Planning Area</label>
                                </div>
                                <div class="radio">
                                        <input id="rd3" name="a_unit_radio" value="DAU" type="radio">
                                        <label for="rd3">Detailed Analysis Unit</label>
                                </div>
                                <div class="radio">
                                        <input id="rd3b" name="a_unit_radio" value="Revenue" type="radio">
                                        <label for="rd3b">Revenue Regions</label>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <!-- Variables Control-->
            <div class="col-md-3">
                <label class="control-label">Variables</label>
                <form class="form-horizontal" id="variablelist">
                    <fieldset>
                        <div class="form-group">
                            <div class="col-xs-12">
                                <div class="radio notrev">
                                        <input id="rd4" name="variables" value="total_water_use" type="radio" checked="checked">
                                        <label for="rd4">Total Water Use</label>
                                </div>
                                <div class="radio notrev">
                                        <input id="rd5" name="variables" value="total_irrigated_crop_area" type="radio">
                                        <label for="rd5">Total Irrigated Crop Area</label>
                                </div>
                                <div class="radio notrev">
                                        <input id="rd6" name="variables" value="applied_water_per_acre" type="radio">
                                        <label for="rd6">Applied Water Per Acre</label>
                                </div>
                                <div class="radio notrev">
                                        <input id="rd7" name="variables" value="evapotranspiration_of_applied_water_per_acre" type="radio">
                                        <label for="rd7">ET of Applied Water Per Acre</label>
                                </div>
                                <div class="radio rev" style="visibility:hidden; display:none">
                                        <input id="rd8" name="variables" value="total_revenue" type="radio">
                                        <label for="rd8">Total Revenue</label>
                                </div>
                                <div class="radio rev" style="visibility:hidden;display:none;">
                                        <input id="rd9" name="variables" value="revenue_per_acre" type="radio">
                                        <label for="rd9">Revenue Per Acre</label>
                                </div>
                                <div class="radio rev" style="visibility:hidden;display:none;">
                                        <input id="rd10" name="variables" value="revenue_per_applied_water" type="radio">
                                        <label for="rd10">Revenue Per Applied Water</label>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <!-- Year Slider -->
            <div class="col-md-3">
                <label class="control-label">Year</label>
                <input id="slider" type="text" data-slider-step="1">
                <span id="sliderCurrentSliderValLabel">Selected Year: <span id="sliderSliderVal"></span></span>
                <script>
                    //$("#slider").slider();
                    $("#slider").on("slide", function(slideEvt) {
                        $("#sliderSliderVal").text(slideEvt.value);
                    });
                </script>
            </div>

            <!-- Legend -->
            <div class="col-md-3">
                <label class="control-label">Legend</label>
                <div class="bg-offwhite" id="legend">
                    <div class = "legend_row">
                        <div class="color_box" id="color_box1" style="background-color:#13b4ff"></div>
                        <label id="legendval1">Loading...</label>
                    </div>
                    <div class = "legend_row">
                        <div class="color_box" id="color_box2" style="background-color:#ab3fdd"></div>
                        <label id="legendval2">Loading...</label>
                    </div>
                    <div class = "legend_row">
                        <div class="color_box" id="color_box3" style="background-color:#ae163e"></div>
                        <label id="legendval3">Loading...</label>
                    </div>
                    <div class = "legend_row">
                        <div class="color_box" id="color_box4" style="background-color:#ae163e"></div>
                        <label id="legendval4">Loading...</label>
                    </div>
                    <div class = "legend_row">
                        <div class="color_box" id="color_box5" style="background-color:#ae163e"></div>
                        <label id="legendval5">Loading...</label>
                    </div>
                    <div>
                        <label id="units"></label>
                    </div>
                </div>
            </div>


        </div>

        <!-- Render window for map -->
        <div class="row">
            <div class="col-md-12" id="map">

            </div>

        </div>

        <!-- Tooltip -->
        <div class="row" >
            <div class="col-md-12">
                <!-- Tooltip -->
                <div id="tooltip" class="hidden">
                    <p><strong id="title">Loading...</strong></p>
                    <span id="value"></span>
                </div>
            </div>
        </div>

        <!-- Begin Script -->
        <script>
            //Globals
            var RECENT_YEAR = 2010;
            //update slider values
            $("#slider").slider({
                min: 1998,
                max: RECENT_YEAR,
                value: RECENT_YEAR
            });
            //update span value for year
            document.getElementById("sliderSliderVal").innerHTML=RECENT_YEAR;
            //Width and height
            var width = document.getElementById("map").offsetWidth;
            //var height = 650;
            //COLORS
            var num_colors = 5;
            var color1 = "rgb(246,242,202)";
            var color2 = "rgb(247,227,167)";
            var color3 = "rgb(250,181,112)";
            var color4 = "rgb(253,106,57)";
            var color5 = "rgb(255,0,0)";
            /*var color1 = "rgb(250,0,0)";
            var color2 = "rgb(250,250,0)";
            var color3 = "rgb(0,250,250)";
            var color4 = "rgb(0,0,250)";
            var color5 = "rgb(250,0,255)";*/
            //colors for cloropleth

            var color = d3.scale.quantize();
            //var color;

            //show legend colors
            for(var i = 1; i <= num_colors; i++) {
                document.getElementById("color_box"+[i]).style.backgroundColor = this["color"+[i]];
            }
            //LEAFLET map
            var OpenStreetMap_Mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });
            var map = new L.Map("map", {center: [37.8, -120.0], zoom: 6})
                    .addLayer(OpenStreetMap_Mapnik);
            var svg = d3.select(map.getPanes().overlayPane).append("svg"),
                    g = svg.append("g").attr("class", "leaflet-zoom-hide");
            var features = svg.append("g");
            //variables to access json
            var a_unit = "HR";
            var var_selection = "total_water_use";
            var year = RECENT_YEAR;
            var property = var_selection + '_' + year;
            //analysis unit radio button listeners
            var au = document.getElementsByName('a_unit_radio');
            for (var i = au.length; i--;) {
                au[i].onchange = function () {
                    a_unit = this.value;
                    //d3.select('svg').text('')
                    d3.selectAll("path").remove();
                    if(a_unit == "Revenue"){
                        //hide other buttons
                        var cols = document.getElementsByClassName('notrev');
                        for(i=0; i<cols.length; i++) {
                            cols[i].style.display = "none";
                        }
                        //make revenue buttons visible
                        var cols = document.getElementsByClassName('rev');
                        for(i=0; i<cols.length; i++) {
                            cols[i].style.display = "block";
                            cols[i].style.visibility = "visible";
                        }
                        $("#rd8").prop("checked", true); //check first option
                        var mySlider = $("#slider").slider();
                        mySlider.slider('setValue', RECENT_YEAR); //set slider val
                        $("#slider").slider("disable"); //disable sliding
                        $("#sliderSliderVal").text(RECENT_YEAR);
                        updateMap(a_unit);
                    }//if revenue selected
                    else{
                        //hide revenue buttons
                        var cols = document.getElementsByClassName('rev');
                        for(i=0; i<cols.length; i++) {
                            cols[i].style.display = "none";
                            cols[i].style.visibility = "hidden";
                        }
                        //make revenue buttons visible
                        var cols = document.getElementsByClassName('notrev');
                        for(i=0; i<cols.length; i++) {
                            cols[i].style.display = "block";
                        }
                        $("#rd4").prop("checked", true); //check first option
                        var mySlider = $("#slider").slider();
                        $("#slider").slider("enable"); //enable sliding
                        if(a_unit == "PA") {
                            mySlider.slider('setValue', RECENT_YEAR); //set slider val
                            $("#sliderSliderVal").text(RECENT_YEAR);
                            $("#slider").slider({
                                min: 1999,
                            });
                        }
                        else{
                            mySlider.slider('setValue', RECENT_YEAR); //set slider val
                            $("#sliderSliderVal").text(RECENT_YEAR);
                            $("#slider").slider({
                                min: 1998,
                            });
                        }
                        updateMap(a_unit);
                    }//if nonrevenue selected
                }
            }
            updateMap(a_unit);

            //Load in GeoJSON data, set callback function
            function updateMap(analysis_unit)
            {
                //spinner start and options
                var target = document.getElementById('map');
                var opts = {
                    lines: 8, // The number of lines to draw
                    length: 15, // The length of each line
                    width: 8, // The line thickness
                    radius: 12, // The radius of the inner circle
                    color: '#000', // #rgb or #rrggbb or array of colors
                    speed: 1.0, // Rounds per second
                    corners: 1, //roundness
                    trail: 40, // Afterglow percentage
                    className: 'spinner', // The CSS class to assign to the spinner
                };
                var spinner = new Spinner(opts).spin(target);
                var hover_opacity = 0.5;
                var normal_opacity = 0.95;

                //Load GeoJSON
                d3.json(analysis_unit + ".geojson", function (json) {
                    //stop loading spinner
                    spinner.stop();
                    //choose property
                    if(analysis_unit == "Revenue"){
                        var_selection = "total_revenue";
                        property = var_selection;
                    }
                    else {
                        var_selection = "total_water_use";
                        var mySlider = $("#slider").slider();
                        year = mySlider.slider('getValue');
                        property = var_selection + '_' + year;
                    }

                    //update the color scale to account for all years of the property
                    updateScale();

                    //Create one path per GeoJSON feature, SVG rendering
                    var transform = d3.geo.transform({point: projectPoint}),
                            path = d3.geo.path().projection(transform);

                    //rseponsive behavior
                    var event;
                    if($("#map").width() > 500){
                        event = "mouseover";
                    }//larger screen
                    else{
                        event = "click";
                    }//mobile

                    var feature = g.selectAll("path")
                            .data(json.features)
                            .enter().append("path")
                            .attr("d", path)
                            .attr("class", "borderline")
                            .attr("stroke", "#555")
                            .attr("stroke-width", "0.6px")
                            .attr("fill", function (d) {
                                //Get data value
                                var value = d.properties[property];
                                if (value) {
                                    //If value exists…
                                    return color(value);
                                } else {
                                    //If value is undefined…
                                    return "#ccc";
                                }
                            })
                            .style("opacity", normal_opacity)
                            .on(event,  function(d){
                                if(analysis_unit == "Revenue" && d.properties["STATE"] == 06){
                                    //Do not display orange highlight
                                }//if
                                else {
                                    d3.select(this)
                                            .attr("fill", "orange")
                                            .style("opacity", hover_opacity);
                                    //change cursor
                                    $('.leaflet-container').css('cursor','pointer');
                                    //Get this bar's x/y values, then augment for the tooltip
                                    var cur_width = $("#map").width();
                                    var cur_height = document.getElementById("map").offsetHeight;
                                    var xPosition = (cur_width - 160) * 0.75;
                                    var yPosition = -cur_height + 40;
                                    //Update the tooltip position and value
                                    var full_name;
                                    switch (analysis_unit) {
                                        case "HR":
                                            full_name = "FIRST_HRNA";
                                            break;
                                        case "PA":
                                            full_name = "pa_name";
                                            break;
                                        case "DAU":
                                            full_name = "DAU_NAME";
                                            break;
                                    }
                                    var tmp_info = "";
                                    if (a_unit != "Revenue") {
                                        //update tooltip inside text
                                        var region_name = full_name;// + "_name"
                                        var tmp_var = "total_water_use_" + year;
                                        tmp_info = "<b>" + "Year: " + "</b>" + year;
                                        tmp_info += "<br/><b>" + "TWU: " + "</b>" + Math.round(100*d.properties[tmp_var])/100 + " TAF";
                                        tmp_var = "total_irrigated_crop_area_" + year;
                                        tmp_info += "<br/><b>" + "TICA: " + "</b>" + Math.round(100*d.properties[tmp_var])/100 + " TA";
                                        tmp_var = "applied_water_per_acre_" + year;
                                        tmp_info += "<br/><b>" + "AWPA: " + "</b>" + Math.round(1000*d.properties[tmp_var])/1000 + " AFPA"
                                        tmp_var = "evapotranspiration_of_applied_water_per_acre_" + year;
                                        tmp_info += "<br/><b>" + "ETAW: " + "</b>" + Math.round(1000*d.properties[tmp_var])/1000 + " AFPA"
                                    }
                                    else if (a_unit == "Revenue") {
                                        var tmp_var = "total_revenue";
                                        tmp_info = "<b>" + "Year: " + RECENT_YEAR + "</b>";
                                        tmp_info += "<br/><b>" + "TR: " + "</b>$";
                                        if (d.properties[tmp_var] != null) //check null
                                            tmp_info += Math.round(d.properties[tmp_var]).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); //remove decimals, add commas
                                        else
                                            tmp_info += d.properties[tmp_var];
                                        tmp_var = "revenue_per_acre";
                                        tmp_info += "<br/><b>" + "RPA: " + "</b>$";
                                        if (d.properties[tmp_var] != null) //check null
                                            tmp_info += Math.round(d.properties[tmp_var]).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "/acre"; //remove decimals, add commas
                                        else
                                            tmp_info += d.properties[tmp_var] + "/acre";
                                        tmp_var = "revenue_per_applied_water";
                                        tmp_info += "<br/><b>" + "RPAW: " + "</b>$";
                                        if (d.properties[tmp_var] != null) //check null
                                            tmp_info += Math.round(d.properties[tmp_var]).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "/AF"; //remove decimals, add commas
                                        else
                                            tmp_info += d.properties[tmp_var] + "/AF";
                                    }
                                    var info = tmp_info;
                                    d3.select("#tooltip").select("#title").text(d.properties[region_name]);
                                    d3.select("#tooltip")
                                            .style("left", xPosition + "px")
                                            .style("top", yPosition + "px")
                                            .select("#value")
                                            .html(info);
                                    //Show the tooltip
                                    d3.select("#tooltip").classed("hidden", false);
                                }//display orange highlight
                            })
                            .on("mouseout", function(d){
                                //reset cursor
                                $('.leaflet-container').css('cursor','');
                                d3.select(this)
                                        .transition()
                                        .duration(250)
                                        .style("opacity", normal_opacity)
                                        .attr("fill", function (d) {
                                            //Get data value
                                            var value = d.properties[property];
                                            if (value) {
                                                //If value exists…
                                                return color(value);
                                            } else {
                                                //If value is undefined…
                                                return "#ccc";
                                            }
                                        })
                                //Hide the tooltip
                                d3.select("#tooltip").classed("hidden", true);
                            });
                    map.on("viewreset", reset);
                    reset();
                    function reset() {
                        var bounds = path.bounds(json),
                                topLeft = bounds[0],
                                bottomRight = bounds[1];
                        svg .attr("width", bottomRight[0] - topLeft[0])
                                .attr("height", bottomRight[1] - topLeft[1])
                                .style("left", topLeft[0] + "px")
                                .style("top", topLeft[1] + "px");
                        g   .attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
                        feature.attr("d", path);
                    }
                    function projectPoint(x, y) {
                        var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                        this.stream.point(point.x, point.y);
                    }

                    //User changed "Variables"
                    var ch = document.getElementsByName('variables');
                    for (var i = ch.length; i--;) {
                        ch[i].onchange = function () {
                            var_selection = this.value;
                            if(a_unit == "Revenue"){
                                property = var_selection;
                            }
                            else {
                                property = var_selection + '_' + year;
                            }

                            //create new scale for newly selected variable
                            updateScale();

                            //refresh fill values
                            svg.selectAll("path")
                                    .transition()
                                    .duration(100)
                                    .attr("fill", function (d) {
                                        //Get data value
                                        var value = d.properties[property];
                                        if (value) {
                                            //If value exists…
                                            return color(value);
                                        } else {
                                            //If value is undefined…
                                            return "#ccc";
                                        }
                                    });
                        }
                    }

                    //User changed "Year"
                    $("#slider").on("slide slideStop", function (slideEvt) {
                        year = (slideEvt.value);
                        property = var_selection + '_' + year; //update property
                        //render again
                        svg.selectAll("path")
                                //.transition()
                                //.duration(100)
                                .attr("fill", function (d) {
                                    //Get data value
                                    var value = d.properties[property];
                                    if (value) {
                                        //If value exists…
                                        return color(value);
                                    } else {
                                        //If value is undefined…
                                        return "#ccc";
                                    }
                                });
                    });

                    function updateScale(){
                        if(analysis_unit == "Revenue") {
                            var sort_ar = [];
                            var min = json.features[0].properties[property],
                                    max = json.features[0].properties[property];

                                for (var i = 0; i < json.features.length; i++) {
                                    if (json.features[i].properties[property] < min) {
                                        min = json.features[i].properties[property];
                                    }//find min
                                    if (json.features[i].properties[property] > max) {
                                        max = json.features[i].properties[property];
                                    }//find max

                                    if(json.features[i].properties[loop_prop] != 0 && json.features[i].properties[property] != null) {
                                        sort_ar.push(json.features[i].properties[property]); //push to sorting ar
                                    }
                                }//loop through json features



                            var t1 = null, t2 = null, t3 = null, t4 = null;

                            //sort values of property for all regions
                            sort_ar.sort(function(x,y){return x - y});

                            for (var i = Math.round(sort_ar.length/num_colors); i < sort_ar.length; i+=Math.round(sort_ar.length/(num_colors))) {
                                if(t1 == null){
                                    t1 = sort_ar[i];
                                }
                                else if(t2 == null){
                                    t2 = sort_ar[i];
                                }
                                else if(t3 == null){
                                    t3 = sort_ar[i];
                                }
                                else if(t4 == null){
                                    t4 = sort_ar[i];
                                }

                            }//find thresholds for each bucket


                            color = d3.scale.threshold()
                                    .domain([t1, t2, t3, t4])
                                    .range([ color1, color2, color3, color4, color5]);
                            t1 = Math.round(100*t1)/100;
                            t2 = Math.round(100*t2)/100;
                            t3 = Math.round(100*t3)/100;
                            t4 = Math.round(100*t4)/100;

                            var t_ar = [t1, t2, t3, t4];
                            updateLegend(min, max, t_ar, var_selection);
                        }//if revenue
                        else {
                            var sort_ar = [];
                            var min = json.features[0].properties[property],
                                max = json.features[0].properties[property];
                            for (var yr = 1998; yr < RECENT_YEAR; yr++) {

                                if((yr == 1998) && (analysis_unit == "PA")){
                                    yr = 1999;
                                }//no data for 1998, need to bump

                                var loop_prop = var_selection + '_' + yr;

                                for (var i = 0; i < json.features.length; i++) {
                                    if (json.features[i].properties[loop_prop] < min) {
                                        min = json.features[i].properties[loop_prop];
                                    }//find min
                                    if (json.features[i].properties[loop_prop] > max) {
                                        max = json.features[i].properties[loop_prop];
                                    }//find max

                                    if(json.features[i].properties[loop_prop] != 0 && json.features[i].properties[loop_prop] != null) {
                                        sort_ar.push(json.features[i].properties[loop_prop]); //push to sorting ar
                                    }
                                }//loop through json features

                            }//search across all years

                            var t1 = null, t2 = null, t3 = null, t4 = null;

                            //sort values of property for all regions
                            sort_ar.sort(function(x,y){return x - y});
                            for (var i = Math.round(sort_ar.length/num_colors); i < sort_ar.length; i+=Math.round(sort_ar.length/(num_colors))) {
                                if(t1 == null){
                                    t1 = sort_ar[i];
                                }
                                else if(t2 == null){
                                    t2 = sort_ar[i];
                                }
                                else if(t3 == null){
                                    t3 = sort_ar[i];
                                }
                                else if(t4 == null){
                                    t4 = sort_ar[i];
                                }

                            }//find thresholds for each bucket


                            color = d3.scale.threshold()
                                    .domain([t1, t2, t3, t4])
                                    .range([ color1, color2, color3, color4, color5]);
                            t1 = Math.round(100*t1)/100;
                            t2 = Math.round(100*t2)/100;
                            t3 = Math.round(100*t3)/100;
                            t4 = Math.round(100*t4)/100;

                            var t_ar = [t1, t2, t3, t4];
                            updateLegend(min, max, t_ar, var_selection);
                        }//if not revenue
                    }//make scale

                    //takes in a min, max, an array of thresholds, and the variable selection
                    function updateLegend(min, max, t_ar, var_selection){
                        for(var i = 1; i <= num_colors; i++) {
                            var calc;
                            var str = "";

                            if(var_selection == "applied_water_per_acre" || var_selection == "evapotranspiration_of_applied_water_per_acre"){
                                //calculate first half of interval (LEFT)
                                if (i == 1) {
                                    calc = min;
                                }//if first section of threshold
                                else {
                                    calc = t_ar[i - 2];
                                }//get threshold

                                calc = Math.round(calc*100)/100;

                                str += calc.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); //add commas every thousandths

                                str += "-"; //to

                                //calculate second half of scale (RIGHT)
                                if (i < num_colors) {
                                    if ((i == 1) && (Math.round(min*100)/100 != Math.round(t_ar[i - 1]*100)/100)) {
                                        calc = t_ar[i - 1] - 0.01;
                                    }//for first index, check left != right
                                    else if ((i > 1) && (Math.round(t_ar[i - 2]*100)/100 != Math.round(t_ar[i - 1]*100)/100)) {
                                        calc = t_ar[i - 1] - 0.01;
                                    }//for rest if left side does not equal right
                                    else {
                                        calc = t_ar[i - 1];
                                    }//else leave it
                                }//not last legend value
                                else {
                                    calc = max;
                                }//last legend value

                                calc = Math.round(calc*100)/100;

                                str += calc.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                                document.getElementById("legendval" + [i]).innerHTML = [str]; //update html
                            }// do -0.01 intervaling
                            else {
                                if (var_selection == "revenue_per_acre" || var_selection == "revenue_per_applied_water") {
                                    str += '$';
                                }//append dollar sign for revenue
                                //calculate first half of interval (LEFT)
                                if (i == 1) {
                                    calc = min;
                                }//if first section of threshold
                                else {
                                    calc = t_ar[i - 2];
                                }//get threshold
                                if (var_selection == "total_revenue") {
                                    calc = Math.round(calc / 1000000);
                                }//if total revenue, turn to millions of dollars
                                else {
                                    calc = Math.round(calc);
                                }//just round
                                str += calc.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); //add commas every thousandths

                                str += "-"; //to

                                if (var_selection == "revenue_per_acre" || var_selection == "revenue_per_applied_water") {
                                    str += '$';
                                }//dollar sign
                                //calculate second half of scale (RIGHT)
                                if (i < num_colors) {
                                    if ((i == 1) && (Math.round(min) != Math.round(t_ar[i - 1]))) {
                                        calc = t_ar[i - 1] - 1;
                                    }//for first index, check left != right
                                    else if ((i > 1) && (Math.round(t_ar[i - 2]) != Math.round(t_ar[i - 1]))) {
                                        calc = t_ar[i - 1] - 1;
                                    }//for rest if left side does not equal right
                                    else {
                                        calc = t_ar[i - 1];
                                    }//else leave it
                                }//not last legend value
                                else {
                                    calc = max;
                                }//last legend value
                                if (var_selection == "total_revenue") {
                                    calc = Math.round(calc / 1000000);
                                }//turn to millions of dollars
                                else {
                                    calc = Math.round(calc);
                                }//just round
                                str += calc.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                                document.getElementById("legendval" + [i]).innerHTML = [str]; //update html
                            }//do normal -1 intervaling

                        }//update intervals

                        //update units
                        var units;
                        if(var_selection == "total_water_use"){
                            units = "Thousand Acre Feet";
                        }
                        switch(var_selection){
                            case "total_water_use":
                                units = "Thousand Acre Feet";
                                break;
                            case "total_irrigated_crop_area":
                                units = "Thousand Acre";
                                break;
                            case "applied_water_per_acre":
                                units = "Acre-Foot Per Acre"
                                break;
                            case "evapotranspiration_of_applied_water_per_acre":
                                units = "Acre-Foot Per Acre"
                                break;
                            case "total_revenue":
                                units = "Millions of Dollars"
                                break;
                            case "revenue_per_acre":
                                units = "$/Acre"
                                break;
                            case "revenue_per_applied_water":
                                units = "$/AF"
                                break;
                            default:
                                units = "Units"
                        }
                        document.getElementById("units").innerHTML = '*' + units;

                    }//updateLegend()

                }); //load analysis unit

            }//updateMap()

        </script>

    </div>

    <p>Data was taken from California Department of Water Resources
        http://www.water.ca.gov/landwateruse/anaglwu.cfm#</p>

</div> <!-- /container -->

</body>
</html>